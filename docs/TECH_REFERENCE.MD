# üìò Agro Risk Engine DaaS - Technical Reference Guide

**Vers√£o do Documento:** 1.0.0
**Status:** Production Core / MVP
**Auditoria T√©cnica:** Raphael Soares
**Stack Principal:** Python 3.10+, FastAPI, Supabase (PostgreSQL), Pandas, AsyncIO.
**Infraestrutura:** Nix (Ambiente Herm√©tico) + uv (Gerenciamento de Pacotes).

> **Nota:** Este documento detalha a arquitetura, decis√µes de design e fluxo de dados do Motor de Risco. Destina-se a desenvolvedores e arquitetos que necessitam compreender a l√≥gica interna e os padr√µes de projeto adotados.

---

## 1. Camada de Configura√ß√£o e Ambiente

### üìÑ `settings.yaml` & `core/env.py`
**Prop√≥sito:** Centraliza√ß√£o de par√¢metros de neg√≥cio e segredos de infraestrutura. Separa a l√≥gica da parametriza√ß√£o.

**Stack Espec√≠fica:**
*   **YAML:** Padr√£o de ind√∫stria para configura√ß√£o leg√≠vel.
*   **Python (`pyyaml`):** Carregamento din√¢mico com suporte a overrides de ambiente.

**Decis√µes de Engenharia:**
*   **Desacoplamento Geogr√°fico:** Coordenadas (`lat`, `lon`) e clusters s√£o definidos no YAML, evitando *hardcoding*. Isso permite adicionar novas regi√µes de monitoramento sem necessidade de *redeploy* da aplica√ß√£o, apenas altera√ß√£o de configura√ß√£o.
*   **Singleton Impl√≠cito:** O m√≥dulo `core/env.py` carrega as configura√ß√µes uma √∫nica vez na inicializa√ß√£o, garantindo consist√™ncia durante o ciclo de vida da aplica√ß√£o.

**Mapeamento de Depend√™ncias:**
*   **Consumidores:** `core/pipeline.py`, `core/market_router.py`, `core/strategies/base.py`.
*   **Fluxo:** Depend√™ncia cr√≠tica (Blocker). O sistema n√£o inicializa sem este m√≥dulo.

---

## 2. Pontos de Entrada (Entry Points)

### üìÑ `main.py` (CLI / Cron)
**Prop√≥sito:** Interface de linha de comando para execu√ß√£o de rotinas agendadas (ETL/Batch).

**An√°lise T√©cnica:**
*   **Argument Parsing:** Utiliza `argparse` para flexibilidade de execu√ß√£o (`--mode morning` vs `--mode watch`).
*   **Resili√™ncia:** Implementa tratamento de exce√ß√µes global (`try/except`) com logging estruturado, prevenindo falhas silenciosas em ambientes de orquestra√ß√£o (ex: Airflow).

### üìÑ `api.py` (Interface DaaS)
**Prop√≥sito:** Exposi√ß√£o dos servi√ßos de risco via API RESTful.

**Stack Espec√≠fica:**
*   **FastAPI:** Framework ass√≠ncrono de alta performance.
*   **Pydantic:** Valida√ß√£o rigorosa de contratos de dados (Input/Output).

**Decis√µes de Engenharia:**
*   **Endpoint `/v1/risk/execute-batch`:** Atualmente implementado como processamento s√≠ncrono para simplicidade do MVP.
*   **Nota de Arquitetura:** Em cen√°rios de alta escala, este endpoint deve evoluir para um padr√£o *Fire-and-Forget*, enfileirando o processamento (RabbitMQ/Celery) e retornando um `job_id` para consulta posterior (Polling/Webhook).

---

## 3. O Cora√ß√£o do Sistema (Core Logic)

### üìÑ `core/pipeline.py` (O Orquestrador)
**Prop√≥sito:** Gerenciamento do ciclo de vida da an√°lise de risco (ETL -> Processamento -> Persist√™ncia).

**Fluxo de Execu√ß√£o:**
1.  **Ingest√£o:** Carrega contratos e dados externos (`_load_data`).
2.  **Enriquecimento:** Calcula correla√ß√µes macroecon√¥micas.
3.  **Processamento:** Delega o c√°lculo para estrat√©gias regionais via `RegionalEngineFactory`.
4.  **Persist√™ncia:** Salva resultados e m√©tricas de auditoria.

**Padr√µes de Projeto:**
*   **Factory Pattern:** Utilizado para instanciar dinamicamente a estrat√©gia de risco correta baseada no estado do contrato, garantindo extensibilidade sem modifica√ß√£o do orquestrador.

### üìÑ `core/engine.py` (A M√°quina de Risco)
**Prop√≥sito:** Implementa√ß√£o agn√≥stica de regras financeiras e matem√°ticas.

**L√≥gica Cr√≠tica:**
*   **Regra de Veto Clim√°tico:** Implementa uma l√≥gica de "Circuit Breaker" no score de cr√©dito. Se `climate_score > 80` (Evento Catastr√≥fico), o hist√≥rico financeiro do cliente tem seu peso reduzido drasticamente, priorizando o risco sist√™mico.
*   **LTV Din√¢mico:** Recalcula o *Loan-to-Value* ajustando o valor da garantia (safra) com base na quebra de produtividade estimada em tempo real.

### üìÑ `core/strategies/*.py` (Strategy Pattern)
**Prop√≥sito:** Encapsulamento de regras de neg√≥cio espec√≠ficas por regi√£o.
*   **`base.py`:** Interface abstrata (ABC) que imp√µe o contrato de implementa√ß√£o.
*   **`mt_strategy.py`:** Implementa l√≥gica de penalidade log√≠stica baseada na dist√¢ncia ao porto e pre√ßo do Diesel.
*   **`pr_strategy.py`:** Implementa l√≥gica para regi√µes com malha log√≠stica consolidada.

---

## 4. Camada de Dados e Infraestrutura

### üìÑ `core/db.py` (Gerenciador de Conex√£o)
**Prop√≥sito:** Abstra√ß√£o da camada de persist√™ncia (Supabase/PostgreSQL).

**Decis√µes de Engenharia:**
*   **Singleton Manual (`_CLIENT_CACHE`):** Implementado para reutilizar conex√µes SSL. Essencial em ambientes *serverless* ou scripts de alta frequ√™ncia para evitar exaust√£o do *pool* de conex√µes do banco de dados.

### üìÑ `core/climate_risk.py` (Ingest√£o Ass√≠ncrona)
**Prop√≥sito:** Cliente HTTP resiliente para dados meteorol√≥gicos.

**Engenharia de Resili√™ncia:**
*   **Controle de Concorr√™ncia:** Utiliza `asyncio.Semaphore` para limitar requisi√ß√µes simult√¢neas, respeitando *Rate Limits* de APIs externas.
*   **Fallback Sint√©tico:** Implementa mecanismo de degrada√ß√£o graciosa. Em caso de indisponibilidade das APIs, o sistema utiliza m√©dias hist√≥ricas para n√£o interromper o pipeline cr√≠tico.

### üìÑ `core/scout.py` (OSINT & NLP)
**Prop√≥sito:** Monitoramento de risco qualitativo via Processamento de Linguagem Natural.
*   **Implementa√ß√£o:** Utiliza modelo Zero-Shot Classification (BART) via Hugging Face API para transformar dados n√£o estruturados (not√≠cias RSS) em vetores de risco estruturados.

---

## 5. Scripts Auxiliares e QA

### üìÑ `scripts/seed_portfolio.py`
**Prop√≥sito:** Gera√ß√£o de dados sint√©ticos para testes de carga e valida√ß√£o de hip√≥teses.
**Metodologia:** Cria clusters de dados intencionais (ex: "Cluster MT Alto Risco" vs "Cluster PR Baixo Risco") para validar a sensibilidade e discrimina√ß√£o do motor de risco.

### üìÑ `scripts/run_backtest.py`
**Prop√≥sito:** Valida√ß√£o temporal do modelo (Walk-Forward Analysis).
**Import√¢ncia:** Simula a execu√ß√£o do modelo em janelas de tempo passadas para aferir a acur√°cia preditiva contra eventos de default reais conhecidos.

---

## 6. Roadmap T√©cnico & Evolu√ß√£o da Arquitetura

Esta se√ß√£o detalha os d√©bitos t√©cnicos conhecidos e o plano de evolu√ß√£o para escalar o sistema para um ambiente de produ√ß√£o distribu√≠do.

### 6.1. D√©bito T√©cnico Conhecido
*   **Cobertura de Testes:** A cobertura atual foca em testes de integra√ß√£o e backtest. Necess√°rio expandir a su√≠te de testes unit√°rios (`tests/`) para cobrir *edge cases* matem√°ticos no `core/engine.py`.
*   **Processamento S√≠ncrono:** A API atual bloqueia a thread durante o c√°lculo. Em cen√°rios de alta carga, isso pode gerar *timeouts*.

### 6.2. Plano de Evolu√ß√£o (To-Be)
1.  **Arquitetura Orientada a Eventos:**
    *   Desacoplar a API do Motor de Risco utilizando uma fila de mensagens (RabbitMQ ou Redis/Celery).
    *   Transformar o endpoint de execu√ß√£o em ass√≠ncrono (*Fire-and-Forget*).

2.  **Containeriza√ß√£o Padr√£o:**
    *   Embora o uso de `Nix` garanta reprodutibilidade, a cria√ß√£o de um `Dockerfile` otimizado (Multi-stage build) √© necess√°ria para facilitar o deploy em orquestradores como Kubernetes (K8s) ou ECS.

3.  **Observabilidade:**
    *   Implementar OpenTelemetry para rastreamento distribu√≠do (Tracing) das chamadas entre os m√≥dulos de Ingest√£o, Motor e Banco de Dados.

### 6.3. Padr√µes de Qualidade (QA)
*   **Type Hinting:** Ado√ß√£o estrita de tipagem est√°tica verificada via `mypy` no pipeline de CI.
*   **Linting:** Padroniza√ß√£o de c√≥digo via `ruff` ou `black`.

### 6.4. Estrat√©gia de Dados & Fontes (Data Strategy)
*   **Limita√ß√µes Atuais (MVP):** O sistema utiliza provedores de dados abertos (Open-Meteo, Yahoo Finance) para fins de demonstra√ß√£o e valida√ß√£o de arquitetura. Estes servi√ßos possuem *Rate Limits* restritivos e lat√™ncia de dados (D+0 com atraso ou D-1).
*   **Requisito para Produ√ß√£o (Enterprise):** A migra√ß√£o para provedores com SLA garantido (ex: Bloomberg, Refinitiv, DTN ou Climatempo) √© mandat√≥ria para garantir:
    *   Dados de mercado em Tempo Real (Low Latency).
    *   Malha clim√°tica de alta resolu√ß√£o (Grids < 5km).
    *   Suporte oficial e estabilidade de API.