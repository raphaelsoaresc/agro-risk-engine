Esta √© a **Documenta√ß√£o T√©cnica de Refer√™ncia (Technical Reference Guide)** do sistema **Agro Risk Monitor - High Ticket (v2.6.0)**. Este documento foi estruturado para servir como guia definitivo para transfer√™ncia de propriedade, auditoria e manuten√ß√£o futura.

---

# üõ∞Ô∏è Agro Risk Monitor - Technical Reference Guide

## 1. Vis√£o Geral da Arquitetura
O sistema √© uma plataforma de intelig√™ncia de risco agr√≠cola baseada em dados, projetada para monitorar vari√°veis clim√°ticas, log√≠sticas e de mercado. A arquitetura segue o padr√£o **Modular Monolith** com separa√ß√£o clara entre ingest√£o de dados, processamento de risco e interface de visualiza√ß√£o.

### Fluxo de Dados Macro:
1.  **Ingest√£o (Ingestion Layer):** Scripts de coleta (`worker_market.py`, `flow/`) buscam dados em tempo real de APIs externas (Yahoo Finance, Open-Meteo, Google News).
2.  **Persist√™ncia (Storage Layer):** Os dados brutos e processados s√£o armazenados no **Supabase** (PostgreSQL).
3.  **Processamento (Intelligence Engine):** O `RiskPipeline` orquestra a an√°lise. Ele utiliza o **Strategy Pattern** para aplicar regras de risco espec√≠ficas por regi√£o (MT, PR) e o **Facade Pattern** para indicadores t√©cnicos e financeiros.
4.  **Sa√≠da (Output Layer):**
    *   **Dashboard:** Interface Streamlit para visualiza√ß√£o em tempo real.
    *   **Relat√≥rios:** Gera√ß√£o de PDFs via `FPDF` e envio de e-mails via `MailerSend`.

---

## 2. Dicion√°rio de Scripts e M√≥dulos

### üìÇ Core (O Cora√ß√£o do Sistema)
*   **`core/pipeline.py`**: Orquestrador principal. Coordena a carga de dados, execu√ß√£o dos motores de risco e disparo de notifica√ß√µes.
*   **`core/engine.py`**: Motor de risco gen√©rico. Cont√©m a l√≥gica de sanitiza√ß√£o de dados e c√°lculos de volatilidade/tend√™ncia.
*   **`core/db.py`**: Gerenciador de conex√£o com o Supabase. Implementa cache de conex√£o para evitar exaust√£o de recursos.
*   **`core/climate_risk.py`**: Interface com APIs de clima. Possui l√≥gica de *fallback* sint√©tico caso as APIs falhem.
*   **`core/scout.py`**: M√≥dulo de OSINT (Open Source Intelligence). Usa IA (Hugging Face) para classificar not√≠cias em "Cr√≠tico", "Oportunidade" ou "Neutro".
*   **`core/report_generator.py`**: Respons√°vel pela constru√ß√£o visual do PDF, incluindo gera√ß√£o de gr√°ficos via Matplotlib.

### üìÇ Interface (Frontend)
*   **`dashboard.py`**: Ponto de entrada da interface Streamlit.
*   **`interface/auth.py`**: Gerenciamento de sess√£o e integra√ß√£o com Supabase Auth.
*   **`interface/pages.py`**: L√≥gica de renderiza√ß√£o das abas (Vis√£o Geral, Mercado, Clima).
*   **`interface/components.py`**: Componentes visuais reutiliz√°veis (Cards de KPI, Gr√°ficos Plotly).

### üìÇ Flow & Workers (Automa√ß√£o)
*   **`worker_market.py`**: Script independente para coleta de pre√ßos de commodities e c√¢mbio.
*   **`flow/origination.py` / `export.py`**: L√≥gicas espec√≠ficas para monitorar o interior (fazendas) e os portos.

---

## 3. Detalhamento de C√≥digo

### Classes Principais

| Classe | Responsabilidade | Heran√ßa/Depend√™ncia |
| :--- | :--- | :--- |
| `RiskPipeline` | Coordena o ciclo de vida da an√°lise de risco. | `DatabaseManager`, `RiskEngine` |
| `BaseRiskStrategy` | Classe abstrata que define a interface para riscos regionais. | `ABC` |
| `MatoGrossoStrategy` | Implementa regras espec√≠ficas (ex: Regra do Diesel/Dist√¢ncia). | `BaseRiskStrategy` |
| `DatabaseManager` | Singleton para opera√ß√µes de CRUD no Supabase. | `supabase-py` |
| `NewsScout` | Coleta e analisa not√≠cias via RSS e NLP. | `httpx`, `HuggingFace API` |

### Fun√ß√µes e M√©todos Cr√≠ticos

#### `RiskEngine.calculate_full_analysis`
*   **O que faz:** Realiza o cruzamento de dados de mercado, clima e log√≠stica para um local espec√≠fico.
*   **Par√¢metros:** `df_market` (DataFrame), `loc_name` (String), `df_climate` (DataFrame).
*   **Retorno:** Um dicion√°rio de scores (0-100) e um dicion√°rio de m√©tricas detalhadas.

#### `FundamentalIndicators.calculate_washout_probability`
*   **O que faz:** Calcula a probabilidade de quebra de contrato (default) baseada no estresse clim√°tico e varia√ß√£o de pre√ßo.
*   **L√≥gica:** Se o pre√ßo sobe muito (incentivo ao default) e o clima √© cr√≠tico (falta de produto), o score atinge o n√≠vel m√°ximo.

#### `ClimateIntelligence.run_full_scan`
*   **O que faz:** Varredura ass√≠ncrona de m√∫ltiplos pontos geogr√°ficos.
*   **Diferencial:** Implementa um **Sem√°foro de Concorr√™ncia** para n√£o ser bloqueado pelas APIs de clima.

---

## 4. Vari√°veis Cr√≠ticas e Configura√ß√µes

### Arquivo `configs/settings.yaml`
Este √© o c√©rebro configur√°vel do projeto.
*   **`tickers`**: Lista de ativos monitorados (ZS=F para Soja, USDBRL=X para D√≥lar).
*   **`risk_thresholds`**: Gatilhos num√©ricos (ex: `rsi_overbought: 70`).
*   **`locations`**: Lista de dicion√°rios contendo lat/lon e `dist_to_port` (usado no c√°lculo de frete).

### Vari√°veis de Ambiente (`.env`)
*   `SUPABASE_URL` / `SUPABASE_SERVICE_ROLE_KEY`: Acesso ao banco de dados.
*   `HUGGINGFACE_API_KEY`: Token para o modelo de classifica√ß√£o de not√≠cias.
*   `MAILERSEND_API_KEY`: Token para envio de e-mails transacionais.

---

## 5. Mapeamento de Rela√ß√µes
1.  **`main.py`** chama **`RiskPipeline`**.
2.  **`RiskPipeline`** consome **`MarketLoader`** para obter dados de pre√ßos.
3.  **`RiskPipeline`** instancia a estrat√©gia correta via **`RegionalEngineFactory`**.
4.  A estrat√©gia (ex: **`ParanaStrategy`**) usa **`TechnicalIndicators`** para validar a volatilidade.
5.  O resultado √© enviado para o **`RiskPersister`**, que grava no Supabase.
6.  O **`RiskNotifier`** verifica se o score global ultrapassou o limite e aciona o **`MailerSend`**.

---

## 6. Guia de Manuten√ß√£o

### Como adicionar uma nova regi√£o de monitoramento?
1.  Crie uma nova classe em `core/strategies/` herdando de `BaseRiskStrategy`.
2.  Implemente os m√©todos de c√°lculo de risco log√≠stico, clim√°tico e de mercado.
3.  Registre a nova regi√£o no `RegionalEngineFactory` dentro de `core/factory.py`.

### Como alterar a sensibilidade do risco de mercado?
*   V√° at√© `core/engine.py` no m√©todo `_calculate_calibrated_market_score`.
*   Ajuste os pesos de `vol_score` e `price_risk`.

### Como modificar o layout do e-mail?
*   Altere os templates HTML em `core/reporting_template.py`.

---

## 7. Depend√™ncias Externas e APIs
*   **Yahoo Finance (yfinance):** Dados hist√≥ricos e tempo real de commodities.
*   **Open-Meteo API:** Previs√£o de precipita√ß√£o e temperatura (Gratuito/Open Source).
*   **WeatherAPI:** Fallback secund√°rio para dados clim√°ticos.
*   **Supabase:** Backend-as-a-Service (PostgreSQL, Auth, Realtime).
*   **Hugging Face (BART Model):** Classifica√ß√£o de texto (Zero-shot classification) para not√≠cias.
*   **MailerSend:** Infraestrutura de envio de e-mails.

---

**Nota de Seguran√ßa:** Este sistema utiliza chaves de API sens√≠veis. Certifique-se de que o arquivo `.env` nunca seja versionado em reposit√≥rios p√∫blicos. A integridade dos dados depende da execu√ß√£o regular do `worker_market.py`.